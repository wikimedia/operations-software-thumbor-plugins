# syntax=docker-registry.wikimedia.org/repos/releng/blubber:v0.12.1
version: v4
base: docker-registry.wikimedia.org/python3-build-buster
apt:
  packages:
    - ca-certificates
    - djvulibre-bin
    - exiftool
    - ffmpeg
    - ghostscript
    - gifsicle
    # T334863
    - imagemagick=8:6.9.10.23+dfsg-2.1+deb10u1+wmf1
    - imagemagick-6.q16=8:6.9.10.23+dfsg-2.1+deb10u1+wmf1
    - libmagickcore-6.q16-6=8:6.9.10.23+dfsg-2.1+deb10u1+wmf1
    - libmagickcore-6.q16-6=8:6.9.10.23+dfsg-2.1+deb10u1+wmf1
    - libmagickwand-6.q16-6=8:6.9.10.23+dfsg-2.1+deb10u1+wmf1
    - libboost-python1.67.0
    - exiv2
    - libgl1-mesa-dri
    - libjpeg-turbo-progs
    - librsvg2-bin
    - libvips-tools
    - nodejs
    - python3-numpy
    - python3-scipy
    - webp
    - wmf-certificates
    - xauth
    - xcftools
    - xvfb

lives:
  in: /srv/service/
runs:
  environment:
    APP_BASE_PATH: /srv/service
python:
  version: python3

variants:
  build:
    apt:
      packages:
        - build-essential
        - gfortran
        - libboost-python-dev
        - libcairo2-dev
        - libcurl4-openssl-dev
        - libexiv2-dev
        - libgif-dev
        - libjpeg-dev
        - liblapack-dev
        - liblapack3
        - libopenblas-base
        - libopenblas-dev
        - libssl-dev
        - libwebp-dev
        - npm
        - pkg-config
    copies: [local]
    builder:
      command: [make, 3d2png]
      requirements:
        - Makefile
    python:
      requirements: [requirements.txt]
    runs: { insecurely: true }
  test:
    python:
      requirements: [requirements.txt, requirements-dev.txt]
    includes: [build]
    entrypoint: [make, test]
  offline-test:
    includes: [test]
    entrypoint: [make, offline-test]
  online-test:
    includes: [test]
    entrypoint: [make, online-test]
  code-coverage:
    includes: [test]
    entrypoint: [make, code-coverage]
  prep:
    includes: [build]
    node: { env: prep }
  dev:
    copies: [prep]
    node: { env: dev }
    runs:
      insecurely: true
      environment:
        PYTHONPATH: "/srv/service:/opt/lib/python/site-packages"
    entrypoint: ["/srv/service/entrypoint.sh"]
  production:
    copies: [prep]
    node: { env: production }
    entrypoint: ["/srv/service/entrypoint-prod.sh", "8888"]
